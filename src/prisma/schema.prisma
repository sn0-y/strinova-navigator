generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
  runtime  = "bun"
}

datasource db {
  provider = "postgresql"
}

// Event System

model Event {
  id                Int           @id @default(autoincrement())
  name              String
  channelId         String
  status            EventStatus   @default(ACTIVE)
  createdAt         DateTime      @default(now())
  minCharacters     Int           @default(0)
  requireAttachment Boolean       @default(false)
  participants      Participant[]
  winners           Winner[]

  reportSent      Boolean @default(false)
  resultChannelId String?

  @@index([channelId, status])
}

model Participant {
  userId         String
  eventId        Int
  submissionLink String?
  event          Event   @relation(fields: [eventId], references: [id])

  @@id([userId, eventId])
  @@index([eventId])
}

model Winner {
  userId    String
  eventId   Int
  inGameUid String?
  claimedAt DateTime?
  event     Event     @relation(fields: [eventId], references: [id])

  @@id([userId, eventId])
  @@unique([eventId, inGameUid])
  @@index([eventId])
}

enum EventStatus {
  ACTIVE
  ENDED
  ARCHIVED
}

// Mod Reward System

model Moderator {
  userId      String  @id
  currentTier Int     @default(3)
  isExempt    Boolean @default(false)

  activities  ModActivity[]
  tierHistory TierHistory[]
}

model ModActivity {
  id        Int       @id @default(autoincrement())
  userId    String
  moderator Moderator @relation(fields: [userId], references: [userId])

  recordedAt DateTime @default(now())

  type        ActivityType
  value       Int          @default(1)
  source      String
  referenceId String?

  actionDetail ActionDetail?
}

model TierHistory {
  id        Int       @id @default(autoincrement())
  userId    String
  moderator Moderator @relation(fields: [userId], references: [userId])

  weekStartDate DateTime
  oldTier       Int
  newTier       Int
  reason        String // "Automated Weekly Drop", "Manual Override", "Maintained"
}

enum ActivityType {
  PUBLIC_CHAT
  MOD_CHAT
  VOICE_MINUTES
  CASE_HANDLED
  TICKET_HANDLED
}

enum ActionDetail {
  WARN
  MUTE
  KICK
  BAN
  CLOSE_TICKET
}
